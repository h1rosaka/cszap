6章~ 10章

p104 ~ 199


18:40 150
19:00に、  170




# 6章
キーバリューストア

join機能とかを諦めて大量のデータを持てるようにしたり、大量の同時リクエスト
1台が死んでも困らないように、最低3台とかにコピーを持たせて、壊れたら自己修復するようになってる。

自分で立ち上げて運用するのは大変なのでオススメしない。
自己修復があるから、ってほっておいたらいつか壊れる
10台でやったのが9台→8台→ってなっていつかなくなる
データセンターでは人が壊れたのを直すオペレーションチームがいる
3台で動いてた時に1台壊れたら2台になって動くけど、1台が裁くトラフィックが1.5倍になって、連鎖的に元気な方も倒れる
なので、大量にサーバーが必要。クラウドを間借りしよう。




パフォーマンス的には、短いキーがより効果的

Dynamoなどのキーバリュストアでは、値は不透明なオブジェクトとして扱われる
    不透明
        >「不透明」は、そのバイト列の構造や意味にまで立ち入らず、あくまで単なるバイト列として処理されるニュアンスを表現している。
    - https://zenn.dev/hassaku63/scraps/fc482625369f4c


CAP定理
    ネットワーク障害は避けられないので、P(Partition Torreranceは必ず対応する)
    Consistency, Availability

    CAのシステムも実はある。
    k8sシステムとか
    100台のうち30 70に分断されたら、CA以外は
    k8sのCAシステムは30と70でそれぞれ動いて、分断されててもそこまで困らないので

Q.p109
「ネットーワークの分断が解消された時点でn3にデータが同期される」のであれば、銀行でもAPシステムを使えば良いのでは？
AさんBさんCさんの残高が、それぞれn1,n2,n3にある時、Cさんだけしばらく使えなくなるが、AさんBさん使えて、後からCさんも同期できるならそれで良さそう。

可用性をとったので、古い情報を参照する必要がある。
つまり100万円おろした後なのに100万円まだあるってなって、もう一回下ろしちゃうかもしれない。



Q.p113
「W + R > Nの場合、最新のデータを持つ重複ノードが少なくとも一つ存在する必要があるため」とあるが、なぜ？

50に書いて(W)、50読みます(R) 全部で100台(N)だと、運が悪いと読んだ50台全部古いやつの可能性がある。
51台読めば大丈夫



Q.p116は競合したjohnSanFransiscoとJohnNyewYorkのどちらを最終的な答えとしたのか
    このロジックはあくまで競合の発生に気づけるよ、というもので、どう解消するかはアプリケーション次第。
    タイムスタンプが大きい方を採用する場合が多い。




一時的な障害
    2がしばらく寝てて、ごめん寝てた間の情報教えて
恒久的な障害
    2が完全に死んで新たなサーバーを足してる



Q.p121~の恒久的な障害の対応、よくわからない
    2が死んで新たな2'を作る
    2'は担当してるデーターブロックAは、1,2,3が担当してた
    1と3のバックアップから大体のデータをもらう
    バックアップとの差分を1,3からもらう。
    差分を効率的に探すアルゴリズムが図6-16
    12このデータの集まりに対してのハッシュとって、差分あったらさらに半分の6このハッシュ...


p127.ブルームフィルタ
    - 特定の要素が集合に含まれているかを高速かつ省メモリで確認するためのデータ構造
    - 「入ってないこと」は確実に確認できるが、「入っている」と判定された場合、偽陽性の可能性がある
    - 仕組み
        - 事前にデータを入れる箱と別に、ブルームフィルタ用チェック表(例:長さ10の配列)を用意する。
        - データAを箱に入れる時、複数の(例:3つ)ハッシュ関数にかけて、答え(a1, a2, a3)をメモる
        - チェック表配列の中の、a1, a2, a3番目のマスにだけ、Trueを入れる。
        - 以降、データB, C..を入れるときも同様。
        - 入ってるかのチェック
            - データXが入ってるかチェックするには、x1, x2, x3を計算して、チェック表の該当マスが全てTrueかを見る。
            - 全てTrueだからと言って、必ず入ってるとは限らないが、少なくとも1個でもFalseなら、その箱には入ってない。

    https://zenn.dev/yuyan/articles/4ccc5584bfdf49

 p128  の表6-2は壊れてるで当てにしない 

# 7章

乱数
    UUIDのサイコロ振る
    macアドレスとかのマシンIDと、タイムスタンプとかから乱数シードを作る

# 8章



P.149 BASE 62変換
    →62進数に変換してるだけ

メリット
    ショートURLのサーバー通るので、何回クリックされたかとか、どの国の人がクリックしたかとかのstasを取れる

デメリット
    詐欺サイトかもしれない
    stats渡したくない人も強制利用になる


できる限り短くすると、密度が高くなって、適当に入れたurlで当たっちゃう、ということが起きる
削除できるのは誰であるべきか
ユーザーごとに同じurlでも違う短いurl返さないと、統計情報が共有されてしまう、などなど




# 9章



Q.p161
    シードURLの選び方
        スポーツってなったとして、具体的にどんなサイトにするのか。wikipediaとか？
    
    urlをたくさん集める
        Twitterとかfacebookの投稿から
        新しいサイトができたらサイトマップに登録してもらう、とか


Q.p173
Robots.txtの目的
検索に見せたくないページ
getでデータ削除できちゃうようなページが昔あったりした
社内向けサイトとか


どうやって更新履歴を把握するのか
    →何回かクロールして、更新されてなかったら、もういいかと判断する




Q. p.192 どのようにデータ損失を防ぐのか
    これで失われなくなる理由。ワーカーの前でなくなったらダメでは？

    メッセージキューは永続化の仕組みが大体入ってるので消えない
    ワーカーはIDとともにリクエスト送って、APNからできたよ連絡を待つ
    APNから返事がないままワーカーがもう一度リクエスト送ると、二重になりそうだが、APNではIDを見て、今実行中かどうか確認する
    実行中なら、実行中だよと返して、まだやってなかったら、やる


p192
    分散システムだから重複するってのは？
    分散システムだから、というより間にネットワーク挟むから。


通知の送られ方
    WIFIあったらコネクション繋ぎっぱなし
    携帯回線だったら、この端末に送るっていうsms的なシステムがあるのでそれで送る
    ネットワーク越しの通知と、ネットワークなしでも出す通知がある(androidのAPIで出せる)

一気にpush通知すると、全員がアプリ使って自分のサーバーにDDoSが来る
Googleサーバーから各androidに通知を送って、そのアプリが立ち上がってどんな内容の画像とかを出すか決める。
アプリが立ち上がると、社内サーバや広告会社のサーバーにアクセスが来るので、トラフィックが増大する
